<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Hiper-DH & MITM (Eve) Simülatörü</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0b0f13; --panel:#0f1720; --card:#0f1822; --muted:#94a3b8; --accent:#7c3aed; --accent-2:#06b6d4; --success:#10b981; --danger:#ef4444;
      --glass: rgba(255,255,255,0.03);
    }
    *{box-sizing:border-box;font-family:Inter,system-ui,Segoe UI,Roboto,'Helvetica Neue',Arial}
    html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg),#071018);color:#e6eef6}
    .wrap{max-width:1200px;margin:28px auto;padding:20px}
    header{display:flex;align-items:center;gap:16px;margin-bottom:18px}
    header h1{font-size:20px;margin:0;color:var(--accent)}
    header p{margin:0;color:var(--muted);font-size:13px}

    .sim-grid{display:grid;grid-template-columns:320px 1fr 320px;gap:18px}

    /* left/right panels */
    .panel{background:linear-gradient(180deg,var(--panel),#071927);border-radius:12px;padding:14px;border:1px solid rgba(255,255,255,0.03);box-shadow:0 6px 30px rgba(3,7,18,0.6)}
    .panel h3{margin:0 0 12px 0;color:var(--accent-2)}
    .controls{display:flex;gap:8px;flex-wrap:wrap}
    .btn{background:var(--glass);border:1px solid rgba(255,255,255,0.04);padding:8px 12px;border-radius:10px;color:var(--muted);cursor:pointer;font-weight:600}
    .btn.primary{background:linear-gradient(90deg,var(--accent),#004aad);color:white;border:none}
    .btn.warn{background:linear-gradient(90deg,#92400e,#f59e0b);color:#071018}
    .toggle{display:inline-flex;align-items:center;gap:8px}
    .small{font-size:13px;color:var(--muted)}

    /* center canvas */
    .canvas-wrap{position:relative;background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);border-radius:12px;padding:18px;min-height:480px;display:flex;align-items:center;justify-content:center}
    svg.network{width:100%;height:460px}

    /* node styles */
    .node{cursor:pointer}
    .monitor{fill:linear-gradient(0deg,#0f1720,#0b1220);stroke:#1f2937;stroke-width:2}

    .node-label{font-size:13px;text-anchor:middle;fill:#dbeafe}

    /* info panel */
    .info{background:linear-gradient(180deg,#071225,#0b1720);padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03)}
    .info-row{display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px dashed rgba(255,255,255,0.02)}
    .info-row:last-child{border-bottom:none}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,monospace;color:#9be7ff}

    /* message bubble animation */
    .packet{fill:var(--accent);stroke:none}
    .packet-mod{fill:var(--danger)}

    /* footer */
    footer{margin-top:14px;color:var(--muted);font-size:13px;text-align:center}

    /* clickable hints */
    .hint{font-size:12px;color:var(--muted);margin-top:8px}

    /* responsive */
    @media (max-width:980px){.sim-grid{grid-template-columns:1fr;}.canvas-wrap{min-height:420px}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div style="width:48px;height:48px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;font-weight:800">MITM</div>
      <div>
        <h1>Hiper-DH & Man‑In‑The‑Middle Simülatörü</h1>
        <p>Alice ↔ Bob iletişimini canlandırın. Eve (MITM) aktifse mesajları yakalar/degistirir. Node'lara tıklayın.</p>
      </div>
    </header>

    <div class="sim-grid">
      <!-- LEFT: Controls / Alice -->
      <div class="panel">
        <h3>Alice (Client)</h3>
        <div class="info">
          <div class="info-row"><div class="small">Gizli Anahtar (a)</div><div id="alicePrivate" class="mono">6</div></div>
          <div class="info-row"><div class="small">Genel Anahtar (A)</div><div id="alicePublic" class="mono">—</div></div>
          <div class="info-row"><div class="small">Ortak Sır (S)</div><div id="aliceSecret" class="mono">—</div></div>
          <div class="info-row">
            <div class="small">Hiper-İşlem Kuralı</div>
            <input type="text" id="ruleInput" class="mono" value="Math.pow(a, b) % n" style="width: 150px; background: transparent; border: 1px solid #334155; color: #9be7ff;">
          </div>
        </div>

        <div style="margin-top:12px" class="controls">
          <button class="btn primary" onclick="setActive('alice')">Alice'i Seç</button>
          <button class="btn" onclick="generate('alice')">Genel Anahtar Hesapla</button>
          <button class="btn" onclick="sendMessage('alice')">Bob'a Mesaj Gönder</button>
        </div>

        <div class="hint">Alice monitörüne tıklayın — ayrıntılar panelde gösterilir.</div>
      </div>

      <!-- CENTER: network visualization -->
      <div class="canvas-wrap panel">
        <svg class="network" viewBox="0 0 1000 460" xmlns="http://www.w3.org/2000/svg">
          <!-- positions: Alice left, Bob right, Eve top-middle -->
          <!-- links (paths) -->
          <defs>
            <filter id="glow">
              <feGaussianBlur stdDeviation="4" result="coloredBlur"/>
              <feMerge>
                <feMergeNode in="coloredBlur"/>
                <feMergeNode in="SourceGraphic"/>
              </feMerge>
            </filter>
          </defs>

          <line id="linkA-E" x1="180" y1="340" x2="500" y2="120" stroke="rgba(255,255,255,0.06)" stroke-width="2" stroke-dasharray="6 6" />
          <line id="linkE-B" x1="500" y1="120" x2="820" y2="340" stroke="rgba(255,255,255,0.06)" stroke-width="2" stroke-dasharray="6 6" />
          <line id="linkA-B" x1="180" y1="340" x2="820" y2="340" stroke="rgba(255,255,255,0.03)" stroke-width="1" />

          <!-- Alice monitor (group) -->
          <g id="alice" class="node" transform="translate(120,260)" onclick="nodeClick('alice')">
            <rect x="40" y="-50" width="120" height="80" rx="8" fill="#071428" stroke="#18384f"/>
            <rect x="58" y="-34" width="84" height="50" rx="4" fill="#021726" stroke="#0b3a4a"/>
            <rect x="90" y="26" width="36" height="10" rx="3" fill="#0b1220"/>
            <text x="100" y="-40" class="node-label">Alice</text>
          </g>

          <!-- Eve monitor -->
          <g id="eve" class="node" transform="translate(460,60)" onclick="nodeClick('eve')">
            <rect x="40" y="-50" width="120" height="80" rx="8" fill="#170b12" stroke="#4a1f2e"/>
            <rect x="58" y="-34" width="84" height="50" rx="4" fill="#2a0f17"/>
            <rect x="90" y="26" width="36" height="10" rx="3" fill="#1a0b0f"/>
            <text x="100" y="-40" class="node-label">Eve (MITM)</text>
          </g>

          <!-- Bob monitor -->
          <g id="bob" class="node" transform="translate(780,260)" onclick="nodeClick('bob')">
            <rect x="40" y="-50" width="120" height="80" rx="8" fill="#061219" stroke="#153046"/>
            <rect x="58" y="-34" width="84" height="50" rx="4" fill="#031423"/>
            <rect x="90" y="26" width="36" height="10" rx="3" fill="#07121a"/>
            <text x="100" y="-40" class="node-label">Bob</text>
          </g>

          <!-- animated packet (initially hidden) -->
          <circle id="packet" cx="0" cy="0" r="8" class="packet" style="visibility:hidden;filter:url(#glow)" />
          <circle id="packetMod" cx="0" cy="0" r="8" class="packet-mod" style="visibility:hidden;filter:url(#glow)" />
        </svg>

        <div style="position:absolute;right:18px;bottom:14px;min-width:220px">
          <div class="info">
            <div class="info-row"><div class="small">Modulus (p)</div><div id="modVal" class="mono">23</div></div>
            <div class="info-row"><div class="small">Üreteç (g)</div><div id="genVal" class="mono">5</div></div>
            <div style="padding-top:8px"><button class="btn" onclick="resetSim()">Sıfırla</button> <button class="btn warn" onclick="toggleEve()" id="eveBtn">Eve: Pasif</button></div>
          </div>
        </div>
      </div>

      <!-- RIGHT: Controls / Bob -->
      <div class="panel">
        <h3>Bob (Server)</h3>
        <div class="info">
          <div class="info-row"><div class="small">Gizli Anahtar (b)</div><div id="bobPrivate" class="mono">15</div></div>
          <div class="info-row"><div class="small">Genel Anahtar (B)</div><div id="bobPublic" class="mono">—</div></div>
          <div class="info-row"><div class="small">Ortak Sır (S)</div><div id="bobSecret" class="mono">—</div></div>
        </div>

        <div style="margin-top:12px" class="controls">
          <button class="btn primary" onclick="setActive('bob')">Bob'u Seç</button>
          <button class="btn" onclick="generate('bob')">Genel Anahtar Hesapla</button>
          <button class="btn" onclick="sendMessage('bob')">Alice'a Mesaj Gönder</button>
        </div>

        <div class="hint">Bob monitörüne tıklayın — ayrıntılar panelde gösterilir.</div>
      </div>
    </div>

    <!-- DETAILS / action log -->
    <div style="margin-top:16px;display:flex;gap:12px;flex-wrap:wrap">
      <div style="flex:1;min-width:320px" class="panel">
        <h3>Seçili Düğüm & Eylemler</h3>
        <div id="selectedInfo" class="info">
          <div class="small">Henüz bir düğüm seçilmedi. Alice/Bob/Eve'ye tıklayın.</div>
        </div>
      </div>

      <div style="width:420px;min-width:280px" class="panel">
        <h3>İşlem Günlüğü</h3>
        <div id="log" style="max-height:180px;overflow:auto;padding:8px;font-size:13px;color:var(--muted)"></div>
      </div>
    </div>

    <footer>Bu simülatör tamamen istemci tarafında çalışır — MITM davranışını görselleştirir. Gerçek kriptografi için güçlü asal sayılar ve kütüphaneler kullanın.</footer>
  </div>

  <script>
    const API_BASE_URL = 'https://hypercrypt.up.railway.app';
    // --- state ---
    const state = {
      modulus: 23,
      generator: 5,
      alicePrivate: 6,
      bobPrivate: 15,
      alicePublic: null,
      bobPublic: null,
      aliceSecret: null,
      bobSecret: null,
      eveActive: false,
      selected: null
    }

    // helpers
    const logEl = document.getElementById('log')
    function log(text){
      const t = document.createElement('div'); t.textContent = `[${new Date().toLocaleTimeString()}] ${text}`; logEl.prepend(t);
    }

    function setActive(who){ state.selected = who; renderSelected(); }

    function renderSelected(){
      const sel = state.selected;
      const el = document.getElementById('selectedInfo'); el.innerHTML='';
      if(!sel){ el.innerHTML = '<div class="small">Henüz bir düğüm seçilmedi. Alice/Bob/Eve\'ye tıklayın.</div>'; return }
      if(sel==='alice' || sel==='bob'){
        const p = document.createElement('div'); p.innerHTML = `
          <div class="info-row"><div class="small">Düğüm</div><div class="mono">${sel.toUpperCase()}</div></div>
          <div class="info-row"><div class="small">Gizli</div><div class="mono">${state[sel+'Private']}</div></div>
          <div class="info-row"><div class="small">Genel</div><div class="mono">${state[sel+'Public'] ?? '—'}</div></div>
          <div class="info-row"><div class="small">Ortak Sır</div><div class="mono">${state[sel+'Secret'] ?? '—'}</div></div>
          <div style="margin-top:8px;display:flex;gap:8px"><button class="btn" onclick="generate('${sel}')">Genel Hesapla</button><button class="btn" onclick="sendMessage('${sel}')">Mesaj Gönder</button></div>
        `; el.appendChild(p);
      } else if(sel==='eve'){
        const p = document.createElement('div'); p.innerHTML = `
          <div class="info-row"><div class="small">Düğüm</div><div class="mono">EVE (MITM)</div></div>
          <div class="info-row"><div class="small">Durum</div><div class="mono">${state.eveActive? 'AKTİF':'PASİF'}</div></div>
          <div style="margin-top:8px;display:flex;gap:8px"><button class="btn" onclick="toggleEve()">Eve Toggle</button><button class="btn" onclick="inspectLast()">Son Paketleri İncele</button></div>
        `; el.appendChild(p);
      }
    }

    // simulate simple modular power using BigInt for safety
   /* function modPow(base, exp, mod){
      base = BigInt(base); exp = BigInt(exp); mod = BigInt(mod);
      let result = 1n; let b = base % mod; let e = exp;
      while(e>0n){ if(e & 1n) result = (result*b)%mod; b=(b*b)%mod; e >>= 1n }
      return result;
    }*/

    async function generate(who) {
        log(`${who.toUpperCase()} genel anahtarını hesaplıyor...`);

        const rule = document.getElementById('ruleInput').value;

        const requestData = {
            generator: state.generator,
            modulus: state.modulus,
            privateKey: (who === 'alice') ? state.alicePrivate : state.bobPrivate,
            theirPublicKey: null, // Genel anahtar hesaplarken bu alan boş gider.
            rule: rule
        };

        try {
            const response = await fetch(`${API_BASE_URL}/api/crypto/calculate-key`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestData)
            });

            const data = await response.json();

            if (response.ok) {
                if (who === 'alice') {
                    state.alicePublic = data.result;
                    document.getElementById('alicePublic').textContent = state.alicePublic;
                } else {
                    state.bobPublic = data.result;
                    document.getElementById('bobPublic').textContent = state.bobPublic;
                }
                log(data.explanation + " Sonuç: " + data.result);
                
                // Eğer her iki genel anahtar da artık biliniyorsa, ortak sırları hesapla.
                if (state.alicePublic && state.bobPublic) {
                    computeSecrets();
                }
            } else {
                log(`Hata: ${data.explanation}`);
                alert(`Hata: ${data.explanation}`);
            }
        } catch (error) {
            log("API'ye bağlanırken bir hata oluştu: " + error.message);
            alert("API'ye bağlanırken bir hata oluştu: " + error.message);
        }
        renderSelected();
    }

    async function computeSecrets() {
        log("Ortak gizli anahtarlar hesaplanıyor...");
        const rule = document.getElementById('ruleInput').value;

        // Alice'in sırrını hesaplamak için istek
        const aliceRequestData = {
            generator: state.generator,
            modulus: state.modulus,
            privateKey: state.alicePrivate,
            theirPublicKey: state.bobPublic, // Bob'un genel anahtarını kullanır
            rule: rule
        };

        // Bob'un sırrını hesaplamak için istek
        const bobRequestData = {
            generator: state.generator,
            modulus: state.modulus,
            privateKey: state.bobPrivate,
            theirPublicKey: state.alicePublic, // Alice'in genel anahtarını kullanır
            rule: rule
        };

        try {
            // İki isteği aynı anda gönderelim (daha verimli)
            const [aliceResponse, bobResponse] = await Promise.all([
                fetch(`${API_BASE_URL}/api/crypto/calculate-key`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(aliceRequestData)
                }),
                fetch(`${API_BASE_URL}/api/crypto/calculate-key`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(bobRequestData)
                })
            ]);

            const aliceData = await aliceResponse.json();
            const bobData = await bobResponse.json();

            if (aliceResponse.ok && bobResponse.ok) {
                state.aliceSecret = aliceData.result;
                state.bobSecret = bobData.result;
                document.getElementById('aliceSecret').textContent = state.aliceSecret;
                document.getElementById('bobSecret').textContent = state.bobSecret;
                
                if (state.aliceSecret === state.bobSecret) {
                    log(`Ortak sırlar başarıyla eşleşti: ${state.aliceSecret}`);
                } else {
                    log(`HATA! Ortak sırlar eşleşmedi: Alice=${state.aliceSecret}, Bob=${state.bobSecret}`);
                }

            } else {
                log("Sır hesaplanırken bir hata oluştu.");
            }

        } catch (error) {
            log("API'ye bağlanırken bir hata oluştu: " + error.message);
        }
        renderSelected();
    }

    // clicking nodes
    function nodeClick(who){ setActive(who); log(who.toUpperCase() + ' seçildi.'); }

    // packet animation helper
    function animatePacket(pathPoints, onEnd, modified=false){
      const svg = document.querySelector('svg.network');
      const packet = document.getElementById(modified? 'packetMod':'packet');
      packet.style.visibility='visible';
      let i=0;
      const step = () => {
        if(i>=pathPoints.length){ packet.style.visibility='hidden'; if(onEnd) onEnd(); return }
        packet.setAttribute('cx', pathPoints[i][0]); packet.setAttribute('cy', pathPoints[i][1]); i++;
        requestAnimationFrame(step);
      }
      step();
    }

    // simulate message send
    function sendMessage(sender){
      const message = (sender==='alice')? 'Merhaba Bob, gizli bilgi.' : 'Merhaba Alice, cevap.';
      log(`${sender.toUpperCase()} -> gönderiyor: "${message}"`);

      // path: Alice -> Eve -> Bob (if Eve active), otherwise direct
      const a = [180,340]; const e = [500,120]; const b = [820,340];

      if(state.eveActive){
        // animate to Eve
        const pathToE = interpolatePath(a, e, 60);
        animatePacket(pathToE, ()=>{
          log('Eve paketi yakaladı. Paket içeriği: "' + message + '"');
          // Eve can modify
          const modifiedMessage = prompt('Eve: Paketi değiştir (boş bırakırsan değiştirme):', message);
          const final = (modifiedMessage===null)? message : (modifiedMessage.trim()===''? message: modifiedMessage);
          if(final!==message) log('Eve paketi değiştirdi -> "' + final + '"');
          // animate from Eve to Bob (show modified packet with red)
          const pathEtoB = interpolatePath(e, b, 60);
          animatePacket(pathEtoB, ()=>{ log('Bob aldı: "' + final + '"'); }, true);
        });
      } else {
        // direct A->B
        const path = interpolatePath(a, b, 120);
        animatePacket(path, ()=>{ log('Bob aldı: "' + message + '"'); });
      }
    }

    // simple linear interpolation to produce points
    function interpolatePath(p1,p2,steps){
      const pts=[]; for(let i=0;i<=steps;i++){ const t=i/steps; const x=p1[0]+(p2[0]-p1[0])*t; const y=p1[1]+(p2[1]-p1[1])*t; pts.push([x,y]); } return pts;
    }

    function toggleEve(){ state.eveActive = !state.eveActive; document.getElementById('eveBtn').textContent = 'Eve: ' + (state.eveActive? 'Aktif':'Pasif'); renderSelected(); log('Eve durumu -> ' + (state.eveActive? 'AKTİF':'PASİF')); }

    function resetSim(){
      state.alicePublic=null; state.bobPublic=null; state.aliceSecret=null; state.bobSecret=null; state.eveActive=false;
      document.getElementById('alicePublic').textContent='—'; document.getElementById('bobPublic').textContent='—';
      document.getElementById('aliceSecret').textContent='—'; document.getElementById('bobSecret').textContent='—'; document.getElementById('eveBtn').textContent='Eve: Pasif';
      log('Simülasyon sıfırlandı.'); renderSelected();
    }

    function inspectLast(){ alert('Günlükten son paketleri kontrol edin.'); }

    // initial render
    document.getElementById('alicePrivate').textContent = state.alicePrivate;
    document.getElementById('bobPrivate').textContent = state.bobPrivate;
    document.getElementById('modVal').textContent = state.modulus;
    document.getElementById('genVal').textContent = state.generator;
    renderSelected();

  </script>
</body>
</html>
